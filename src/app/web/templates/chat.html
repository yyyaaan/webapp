{% extends 'base.html' %}
{% block title %}Agent Requirements Collector{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="text-muted small mb-2 ms-1">ðŸŽ¯ Current Requirements Status:</h4>
        <div id="integration-specs-display" class="row g-2"></div>
    </div>
</div>

<div class="row">
    <div class="col-12 col-lg-8 mx-auto">
        <div class="card border-0 shadow-sm" style="border-radius: 20px;">
            <div class="card-body d-flex flex-column" style="height:70vh">
                
                <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3 pe-2">
                    <div class="message-container assistant-container mb-3">
                        <div class="bubble assistant">Hello! I am here to listen to your wishes and requirements for AI integration. Let's get started!</div>
                    </div>
                </div>

                <form id="chat-form"
                      hx-post="/chat/stream" 
                      hx-target="#chat-messages" 
                      hx-swap="beforeend">
                    
                    <input type="hidden" id="chat-state-store" name="chat_history_json" value='[]'>
                    
                    <input type="hidden" id="session-id-store" name="session_id" value=''>
                    
                    <div class="chat-input-pill d-flex align-items-center">
                        <textarea id="chat-input" 
                                  name="message" 
                                  class="form-control border-0 shadow-none bg-transparent" 
                                  placeholder="Type your message here..." 
                                  rows="1"
                                  style="resize: none; overflow-y: hidden;"></textarea>
                        
                        <button id="chat-send" class="btn btn-primary rounded-circle ms-2" type="submit" style="width: 40px; height: 40px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>

                <div class="text-center mt-2">
                    <a href="/chat" class="text-muted small text-decoration-none opacity-75 hover-opacity-100">
                        <i class="fas fa-rotate-right me-1"></i> Start a new session
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    /* --- Chat Bubbles --- */
    .bubble { padding: 12px 18px; border-radius: 18px; display: inline-block; word-break: break-word; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.5; }
    .bubble.user { background: #007bff; color: white; border-bottom-right-radius: 4px; margin-left: auto; }
    .bubble.assistant { background: #f0f2f5; color: #1c1e21; border-bottom-left-radius: 4px; }
    .bubble.loading { background: transparent; color: #888; font-style: italic; padding-left: 0;}

    /* --- Message Containers --- */
    .message-container { display: flex; flex-direction: column; width: 100%; }
    .user-container { align-items: flex-end; }
    .assistant-container { align-items: flex-start; }

    /* --- Feedback Icons (Outside Bubble) --- */
    .feedback-icon { cursor: pointer; color: #ccc; font-size: 0.9rem; transition: color 0.2s; }
    .feedback-icon:hover { color: #666; }
    .feedback-icon.active-up { color: #28a745; }
    .feedback-icon.active-down { color: #dc3545; }

    /* --- Rounded Input Pill --- */
    .chat-input-pill {
        background: #f0f2f5;
        border-radius: 25px;
        padding: 5px 10px 5px 20px;
        border: 1px solid transparent;
        transition: border-color 0.2s, background 0.2s;
    }
    .chat-input-pill:focus-within {
        background: #fff;
        border-color: #007bff;
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
    }

    /* --- Spec Boxes --- */
    .spec-box {
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        min-height: 55px;
        border: 1px solid #eee;
        background-color: #fff;
        color: #333;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        cursor: help; /* Indicates hoverability */
    }
    .spec-box.filled { background-color: #f0fff4; border-color: #c6f6d5; color: #22543d; }
    .spec-box .field-label { display: block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #718096; margin-bottom: 4px; letter-spacing: 0.5px; }
    
    /* Scrollbar Polish */
    #chat-messages::-webkit-scrollbar { width: 6px; }
    #chat-messages::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 10px; }
</style>

<script>
    // 1. Auto-resize textarea logic
    const tx = document.getElementById('chat-input');
    tx.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
        if(this.value === "") this.style.height = "auto"; // Reset on clear
    });

    // 2. Submit on Enter
    tx.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            htmx.trigger('#chat-form', 'submit'); 
            this.style.height = "auto"; // Reset height
        }
    });

    // 3. Before Request (User Bubble & Loader)
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if(evt.target.id !== "chat-form") return;

        const messages = document.getElementById('chat-messages');
        const input = document.getElementById('chat-input');
        
        if (input.value.trim()) {
            // Wrap user message in container for alignment
            const container = document.createElement('div');
            container.className = 'message-container user-container mb-3';
            container.innerHTML = `<div class='bubble user'>${input.value}</div>`;
            messages.appendChild(container);
        }
        
        // Add Loader
        const loader = document.createElement('div');
        loader.id = 'agent-loading';
        loader.className = 'message-container assistant-container mb-3';
        loader.innerHTML = '<div class="bubble loading"><i class="fas fa-circle-notch fa-spin me-2"></i> Thinking...</div>';
        messages.appendChild(loader);

        input.value = '';
        messages.scrollTop = messages.scrollHeight; 
    });

    // 4. After Swap (Render Specs + Clean up)
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const loading = document.getElementById('agent-loading');
        if (loading) loading.remove();
        
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight; 
        
        // Update Specs
        const stateInput = document.getElementById('chat-state-store');
        if (stateInput) {
            try {
                const fullHistory = JSON.parse(stateInput.value);
                const lastMsg = fullHistory.filter(m => m.role === 'assistant').pop();
                if (lastMsg) renderSpecsDisplay(JSON.parse(lastMsg.content).extracted_data);
            } catch (e) { console.warn(e); }
        }
    });

    // 5. Specs Renderer (With Tooltip Logic)
    function renderSpecsDisplay(specs) {
        const displayContainer = document.getElementById('integration-specs-display');
        const fieldMap = {
            goal_and_func: "Primary Goal & Function",
            data_connection: "Data Connection",
            metrics: "Metrics",
            strategic_fit: "Strategic Fit",
            risks: "Risks",
            experimental_ideas: "Experimental Ideas",
            other_wishes: "Other Wishes"
        };
        
        let html = '';
        for (const [key, label] of Object.entries(fieldMap)) {
            const value = specs[key] || '';
            const isFilled = value && value !== 'N/A' && value.trim() !== '';
            
            // Truncate logic
            const displayValue = isFilled ? (value.length > 70 ? value.substring(0, 70) + '...' : value) : 'N/A';
            const sizeClass = (key === 'goal_and_func') ? 'col-6' : 'col-6 col-md-4 col-lg-3';
            
            // Escape quotes for the title attribute
            const safeTitle = value.replace(/"/g, '&quot;');

            html += `
                <div class="${sizeClass}">
                    <div class="spec-box ${isFilled ? 'filled' : 'empty'}" title="${safeTitle}">
                        <span class="field-label">${label}</span> 
                        ${displayValue}
                    </div>
                </div>
            `;
        }
        displayContainer.innerHTML = html;
    }

    // feedback system 
    function prepareFeedbackContext(historyValue, targetMsgId, vote) {
        let chatHistory;
        try {
            chatHistory = JSON.parse(historyValue);
        } catch(e) {
            console.error("Failed to parse history for feedback context.", e);
            return [];
        }

        const sanitizedContext = [];
        
        chatHistory.forEach((msg) => {
            if (msg.role === 'system') return; // Skip system prompt

            const contextMsg = {
                role: msg.role,
                content_snapshot: msg.content,
                extracted_data_snapshot: null, // Still pull out structured data for logging
                user_feedback: null,
            };

            // 1. Identify Target Message and Mark Feedback
            if (msg.message_id === targetMsgId) {
                contextMsg.user_feedback = vote;
            } else if (msg.feedback) {
                 // Preserve feedback from previous votes on other messages
                 contextMsg.user_feedback = msg.feedback;
            }
            
            // 2. Extract structured data for logging purposes (if available)
            if (msg.role === 'assistant') {
                try {
                    const payload = JSON.parse(msg.content);
                    contextMsg.extracted_data_snapshot = payload.extracted_data;
                } catch (e) {
                    // Ignore non-JSON assistant messages
                }
            }
            
            sanitizedContext.push(contextMsg);
        });
        
        return sanitizedContext;
    }


    // --- FEEDBACK CLICK HANDLER ---
    document.addEventListener('click', async function(e) {
        if (!e.target.classList.contains('feedback-icon')) return;
        
        const icon = e.target;
        const msgId = icon.dataset.msgId; 
        const type = icon.dataset.type;
        const statusSpan = document.getElementById(`status-${msgId}`);
        
        // 1. Gather Context & Prepare Sanitized Snapshot
        const sessionId = document.getElementById('session-id-store').value;
        const historyValue = document.getElementById('chat-state-store').value;
        
        // This function now precisely targets the message using msgId
        const sanitizedContext = prepareFeedbackContext(historyValue, msgId, type);

        statusSpan.textContent = "...";
        
        try {
            const res = await fetch('/chat/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    session_id: sessionId,
                    message_id: msgId, 
                    feedback: type,
                    sanitized_context: sanitizedContext
                })
            });
            
            if(res.ok) {
                statusSpan.textContent = "Saved!";
                
                // IMPORTANT: Update the live history in the DOM to reflect the vote
                // ------------------------------------------------------------------
                let liveHistory = JSON.parse(historyValue);
                liveHistory.forEach(msg => {
                    if (msg.message_id === msgId) {
                        msg.feedback = type; // Set the feedback field in the live history
                    }
                });
                // Write the updated history back to the hidden input
                document.getElementById('chat-state-store').value = JSON.stringify(liveHistory).replace(/'/g, '&#39;'); 
                // We use replace to safely handle internal single quotes if they existed, though the backend's escape() is primary.
                // ------------------------------------------------------------------

                // Toggle active class visually
                icon.parentElement.querySelectorAll('.feedback-icon').forEach(i => i.classList.remove('active-up', 'active-down'));
                icon.classList.add(type === 'up' ? 'active-up' : 'active-down');
            }
        } catch (err) { console.error(err); statusSpan.textContent = "Failed"; }
    });
</script>
{% endblock %}