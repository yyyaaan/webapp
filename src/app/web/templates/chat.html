{% extends 'base.html' %}

{% block title %}Agent Requirements Collector{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12 col-lg-8 mx-auto mb-4">
        <h4 class="text-muted small mb-3">ðŸŽ¯ Current Requirements Status:</h4>
        <div id="integration-specs-display" class="row g-2">
            <div class="col-6 col-md-4"><div class="spec-box empty">Main Goal: N/A</div></div>
            <div class="col-6 col-md-4"><div class="spec-box empty">Data Connection: N/A</div></div>
            <div class="col-6 col-md-4"><div class="spec-box empty">Metrics: N/A</div></div>
            <div class="col-6 col-md-4"><div class="spec-box empty">Strategic Fit: N/A</div></div>
            <div class="col-6 col-md-4"><div class="spec-box empty">Risks: N/A</div></div>
            <div class="col-6 col-md-4"><div class="spec-box empty">Experimental Ideas: N/A</div></div>
            <div class="col-12"><div class="spec-box empty">Other Wishes: N/A</div></div>
        </div>
    </div>
    
    <div class="col-12 col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body d-flex flex-column" style="height:70vh">
                
                <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3">
                    <div class="bubble assistant" style="margin-right: auto; max-width: 90%;">Hello! I am here to listen to your wishes and requirements for AI integration. Let's get started!</div>
                </div>

                <form id="chat-form"
                      hx-post="/chat/stream" 
                      hx-target="#chat-messages" 
                      hx-swap="beforeend"
                      class="input-group">
                    
                    <input type="hidden" 
                           id="chat-state-store" 
                           name="chat_history_json" 
                           value='[]'>
                    
                    <textarea id="chat-input" 
                              name="message" 
                              class="form-control" 
                              placeholder="Describe your goal (e.g., 'Increase sales performance')..." 
                              rows="2"></textarea>
                    
                    <button id="chat-send" class="btn btn-primary" type="submit">Send</button>
                </form>

            </div>
        </div>
    </div>
</div>


<style>
    /* Base Styles */
    .bubble { max-width: 80%; padding: .6rem 1rem; border-radius: 16px; margin-bottom: .5rem; display: inline-block; word-break: break-word; white-space: pre-wrap;}
    .bubble.user { background: #e9f5ff; margin-left: auto; align-self: flex-end; }
    .bubble.assistant { background: #f1f1f1; margin-right: auto; align-self: flex-start; }
    .bubble.loading { background: #ffe9e9; color: #cc3333; margin-right: auto; }
    #chat-messages { display:flex; flex-direction:column; gap:6px; }
    
    /* Specs Boxes Styling */
    .spec-box {
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        min-height: 40px;
        border: 1px solid #e0e0e0;
        background-color: #ffffff;
        color: #333;
        transition: all 0.2s ease-in-out;
    }
    .spec-box.empty {
        background-color: #f7f7f7;
        color: #999;
        font-style: italic;
    }
    .spec-box.filled {
        background-color: #e6ffe6; /* Light Green */
        border-color: #8cff8c;
    }
    .spec-box span.field-label {
        font-weight: 700;
        display: block;
        margin-bottom: 2px;
        color: #555;
        font-size: 0.8rem;
    }
</style>

<script>
    // --- HTMX-Friendly JavaScript ---
    
    // 1. Enter Key Submission (kept your logic)
    document.getElementById('chat-input').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            htmx.trigger('#chat-form', 'submit'); 
        }
    });

    // 2. Add Loading Spinner/Text before submission
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        const input = document.getElementById('chat-input');
        const messages = document.getElementById('chat-messages');

        // Render user bubble immediately
        const msg = input.value.trim();
        if (msg) {
            const userBubble = document.createElement('div');
            userBubble.className = 'bubble user';
            userBubble.textContent = msg;
            messages.appendChild(userBubble);
        }
        
        // Add Loading bubble
        const loadingBubble = document.createElement('div');
        loadingBubble.id = 'agent-loading'; // Give it an ID to target for removal
        loadingBubble.className = 'bubble loading';
        loadingBubble.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Thinking...';
        messages.appendChild(loadingBubble);

        input.value = '';
        messages.scrollTop = messages.scrollHeight; 
    });

    // 3. Remove Loading Spinner after response and update specs display
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const messages = document.getElementById('chat-messages');
        const loadingBubble = document.getElementById('agent-loading');
        if (loadingBubble) {
            loadingBubble.remove(); // Remove the loading message after response is swapped
        }
        
        // Scroll to the bottom to see the new message and remove the loading spinner
        messages.scrollTop = messages.scrollHeight; 

        // Update Specs Display after the OOB swap ensures we use the latest state
        const stateInput = document.getElementById('chat-state-store');
        if (stateInput) {
            try {
                // Get the latest history and find the last structured response
                const fullHistory = JSON.parse(stateInput.value);
                const lastAssistantMessage = fullHistory.filter(m => m.role === 'assistant').pop();
                
                if (lastAssistantMessage && lastAssistantMessage.content) {
                    const agentResponse = JSON.parse(lastAssistantMessage.content);
                    renderSpecsDisplay(agentResponse.extracted_data);
                }
            } catch (e) {
                console.warn("Could not parse history or agent response for display:", e);
            }
        }
    });

    // --- 4. Function to Render the Beautified Specs ---
    function renderSpecsDisplay(specs) {
        const displayContainer = document.getElementById('integration-specs-display');
        if (!displayContainer) return;

        const fieldMap = {
            main_goal: "Main Goal",
            data_connection: "Data Connection",
            metrics: "Metrics",
            strategic_fit: "Strategic Fit",
            risks: "Risks",
            experimental_ideas: "Experimental Ideas",
            other_wishes: "Other Wishes"
        };
        
        // Helper function to check for non-empty string content
        const hasContent = (value) => value && value.trim() !== 'N/A' && value.trim() !== '';

        let html = '';
        let specs_html = '';
        
        for (const [key, label] of Object.entries(fieldMap)) {
            const value = specs[key] || 'N/A';
            const isFilled = hasContent(value);
            const sizeClass = (key === 'other_wishes') ? 'col-12' : 'col-6 col-md-4';
            
            // Limit text length for display purposes in the box
            const displayValue = hasContent(value) ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : 'N/A';

            specs_html += `
                <div class="${sizeClass}">
                    <div class="spec-box ${isFilled ? 'filled' : 'empty'}">
                        <span class="field-label">${label}:</span> 
                        ${displayValue}
                    </div>
                </div>
            `;
        }
        
        displayContainer.innerHTML = specs_html;
    }
    
    // Initial call to render the empty state when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Find the initial state from the hidden input and render it
        const stateInput = document.getElementById('chat-state-store');
        if (stateInput && stateInput.value) {
             // The very first state is just the system prompt, so we initialize with empty specs
             renderSpecsDisplay({});
        }
    });

</script>

{% endblock %}